version: 2.1

jobs:
  test:
    docker:
      - image: cimg/python:3.10
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            pip install pytest requests beautifulsoup4
      - run:
          name: Run Dynamic Tests and Summarize
          command: |
            pytest test_login_page.py -v --tb=short | tee pytest_output.txt
            echo "\n==================== DYNAMIC TEST SUMMARY ===================="
            # Parse test types, names, and results
            TEST_TYPES=$(grep -oP '(?<=Test: ).*' test_login_page.py | sort | uniq | tr '\n' ', ' | sed 's/, $//')
            if [ -z "$TEST_TYPES" ]; then
              TEST_TYPES=$(grep -oP 'def test_\w+' test_login_page.py | sed 's/def //g' | tr '\n' ', ' | sed 's/, $//')
            fi
            echo "Test Types: ${TEST_TYPES:-Unknown}"
            TOTAL=$(grep -cE '^test_' test_login_page.py)
            echo "Total Test Cases: $TOTAL"
            echo "Test Case Results:"
            grep -E '::test_' pytest_output.txt | awk '{print "  - " $1 ": " $2}'
            PASSED=$(grep -c ' PASSED' pytest_output.txt)
            FAILED=$(grep -c ' FAILED' pytest_output.txt)
            echo "Passed: $PASSED"
            echo "Failed: $FAILED"
            if [ "$FAILED" -eq 0 ]; then
              echo "Final Status: PASSED"
            else
              echo "Final Status: FAILED"
            fi

workflows:
  version: 2
  main:
    jobs:
      - test