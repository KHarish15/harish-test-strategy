version: 2.1

jobs:
  test:
    docker:
      - image: cimg/python:3.10
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            pip install pytest requests
      - run:
          name: Create uploaded files
          command: |
            # Set default values if parameters are not provided
            CODE_FILENAME=${CODE_FILENAME:-"main.py"}
            TEST_FILENAME=${TEST_FILENAME:-"test_main.py"}
            
            # Create the code file from pipeline parameters
            if [ -n "$CODE_CONTENT" ]; then
              echo "$CODE_CONTENT" | base64 -d > "$CODE_FILENAME"
              echo "✅ Created code file: $CODE_FILENAME"
            else
              echo "⚠️ No CODE_CONTENT provided, creating sample file"
              echo 'def add(a, b): return a + b' > "$CODE_FILENAME"
              echo "✅ Created sample code file: $CODE_FILENAME"
            fi
            
            # Create the test file from pipeline parameters  
            if [ -n "$TEST_CONTENT" ]; then
              echo "$TEST_CONTENT" | base64 -d > "$TEST_FILENAME"
              echo "✅ Created test file: $TEST_FILENAME"
            else
              echo "⚠️ No TEST_CONTENT provided, creating sample test file"
              echo 'import pytest' > "$TEST_FILENAME"
              echo 'def test_add(): assert True' >> "$TEST_FILENAME"
              echo "✅ Created sample test file: $TEST_FILENAME"
            fi
            
            # Show file contents for verification
            echo "📄 Code file contents:"
            cat "$CODE_FILENAME"
            echo ""
            echo "📄 Test file contents:"
            cat "$TEST_FILENAME"
      - run:
          name: Run tests
          command: |
            python -m pytest "$TEST_FILENAME" -v --tb=short
      - run:
          name: Dynamic Test Summary
          command: |
            python run_dynamic_tests.py

workflows:
  version: 2
  main:
    jobs:
      - test
