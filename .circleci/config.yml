version: 2.1

# Define parameters that can be passed to the pipeline
parameters:
  code_content:
    type: string
    default: ""
  test_content:
    type: string
    default: ""
  code_filename:
    type: string
    default: "python_sample.py"
  test_filename:
    type: string
    default: "input_file.py"

jobs:
  test:
    docker:
      - image: cimg/python:3.10
    environment:
      CODE_CONTENT: << pipeline.parameters.code_content >>
      TEST_CONTENT: << pipeline.parameters.test_content >>
      CODE_FILENAME: << pipeline.parameters.code_filename >>
      TEST_FILENAME: << pipeline.parameters.test_filename >>
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            pip install pytest requests
      - run:
          name: Setup test environment
          command: |
            # Copy run_dynamic_tests.py if it exists in the repository
            if [ -f "run_dynamic_tests.py" ]; then
              echo "âœ… Found run_dynamic_tests.py"
            else
              echo "âš ï¸ run_dynamic_tests.py not found - creating basic version"
              cat > run_dynamic_tests.py << 'EOF'
import subprocess
import re
import sys
import os

def run_pytest_and_parse():
    test_filename = os.getenv('TEST_FILENAME', 'input_file.py')
    print(f"ğŸ” Looking for tests in: {test_filename}")
    
    result = subprocess.run(
        ['pytest', test_filename, '--tb=short', '-q'],
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT,
        text=True
    )
    output = result.stdout

    passed = failed = 0
    summary_match = re.search(r'(\d+) passed', output)
    if summary_match:
        passed = int(summary_match.group(1))
    failed_match = re.search(r'(\d+) failed', output)
    if failed_match:
        failed = int(failed_match.group(1))
    total = passed + failed

    print(f"No of test cases: {total}")
    print(f"No of test cases passed: {passed}")
    print(f"No of test cases failed: {failed}")

if __name__ == "__main__":
    run_pytest_and_parse()
EOF
            fi
      - run:
          name: Create uploaded files
          command: |
            # Set default values if parameters are not provided
            CODE_FILENAME=${CODE_FILENAME:-"python_sample.py"}
            TEST_FILENAME=${TEST_FILENAME:-"input_file.py"}
            
            echo "ğŸ“‹ Using filenames: CODE_FILENAME=$CODE_FILENAME, TEST_FILENAME=$TEST_FILENAME"
            echo "ğŸ” Debug: CODE_CONTENT length: ${#CODE_CONTENT}"
            echo "ğŸ” Debug: TEST_CONTENT length: ${#TEST_CONTENT}"
            
            # Create the code file from pipeline parameters
            if [ -n "$CODE_CONTENT" ]; then
              echo "ğŸ” Attempting to decode CODE_CONTENT..."
              if echo "$CODE_CONTENT" | base64 -d > "$CODE_FILENAME" 2>/dev/null; then
                echo "âœ… Created code file: $CODE_FILENAME"
                echo "ğŸ“„ Code file contents:"
                cat "$CODE_FILENAME"
              else
                echo "âŒ Failed to decode CODE_CONTENT - invalid base64"
                echo "ğŸ” CODE_CONTENT preview: ${CODE_CONTENT:0:50}..."
                exit 1
              fi
            else
              echo "âš ï¸ No CODE_CONTENT provided - cannot create code file"
              echo "âŒ Pipeline will fail - code content is required"
              exit 1
            fi
            
            echo ""
            
            # Create the test file from pipeline parameters  
            if [ -n "$TEST_CONTENT" ]; then
              echo "ğŸ” Attempting to decode TEST_CONTENT..."
              if echo "$TEST_CONTENT" | base64 -d > "$TEST_FILENAME" 2>/dev/null; then
                echo "âœ… Created test file: $TEST_FILENAME"
                echo "ğŸ“„ Test file contents:"
                cat "$TEST_FILENAME"
              else
                echo "âŒ Failed to decode TEST_CONTENT - invalid base64"
                echo "ğŸ” TEST_CONTENT preview: ${TEST_CONTENT:0:50}..."
                exit 1
              fi
            else
              echo "âš ï¸ No TEST_CONTENT provided - creating basic test file"
              # Create a basic test file that imports the code
              cat > "$TEST_FILENAME" << 'EOF'
import pytest
import sys
import os

# Add the current directory to Python path
sys.path.insert(0, os.getcwd())

# Import the code file (without .py extension)
code_module = "$CODE_FILENAME".replace('.py', '')
try:
    exec(f"import {code_module}")
    print(f"âœ… Successfully imported {code_module}")
except Exception as e:
    print(f"âš ï¸ Could not import {code_module}: {e}")

def test_basic():
    """Basic test to verify the code can be imported and executed"""
    assert True
    print("âœ… Basic test passed")

def test_code_import():
    """Test that the code file can be imported"""
    try:
        exec(f"import {code_module}")
        assert True
    except Exception as e:
        assert False, f"Failed to import {code_module}: {e}"
EOF
              echo "âœ… Created basic test file: $TEST_FILENAME"
              echo "ğŸ“„ Test file contents:"
              cat "$TEST_FILENAME"
            fi
            
            echo ""
            echo "ğŸ” Files created in current directory:"
            ls -la *.py
            
            # Validate that files were created
            if [ ! -f "$CODE_FILENAME" ]; then
              echo "âŒ Code file $CODE_FILENAME was not created"
              exit 1
            fi
            
            if [ ! -f "$TEST_FILENAME" ]; then
              echo "âŒ Test file $TEST_FILENAME was not created"
              exit 1
            fi
            
            echo "âœ… All files created successfully"
            
            # Export variables for next steps
            echo "CODE_FILENAME=$CODE_FILENAME" >> $BASH_ENV
            echo "TEST_FILENAME=$TEST_FILENAME" >> $BASH_ENV
      - run:
          name: Run tests
          command: |
            echo "ğŸ§ª Running tests on: $TEST_FILENAME"
            echo "ğŸ“„ Using code file: $CODE_FILENAME"
            echo ""
            echo "ğŸ” Available test files:"
            ls -la *.py
            echo ""
            python -m pytest "$TEST_FILENAME" -v --tb=short
      - run:
          name: Dynamic Test Summary
          command: |
            echo "ğŸ“Š Generating test summary..."
            echo "ğŸ” Using test file: $TEST_FILENAME"
            python run_dynamic_tests.py

workflows:
  version: 2
  main:
    jobs:
      - test:
          filters:
            branches:
              only: main
